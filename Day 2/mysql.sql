USE toothsi_training;
CREATE TABLE USERS(
ID INT PRIMARY KEY AUTO_INCREMENT,
FIRST_NAME VARCHAR(20) NOT NULL,
LAST_NAME VARCHAR(20) NOT NULL,
EMAIL VARCHAR(50) NOT NULL UNIQUE,
PHONE VARCHAR(10) NOT NULL,
CREATED_AT TIMESTAMP DEFAULT NOW(),
UPDATED_AT TIMESTAMP DEFAULT NOW() ON UPDATE NOW()
);

INSERT INTO USERS(ID,FIRST_NAME,LAST_NAME,EMAIL,PHONE)
VALUES('1','SUMIT','SINGH','xyz@gmail.com','9089786756'),('2','KAPIL','SHARMA','@abc@gmail.com','8877906545'),('3','PIYUSH','GUPTA','agh@gmail.com','7789675645'),('4','AANCHAL','SHARMA','pqr@gmail.com','9878675645'),('5','VIHAAN','THAKUR','opa@gmail.com','8978675645');

CREATE TABLE PRODUCTS(
PRODUCT_ID INT PRIMARY KEY AUTO_INCREMENT,
PRODUCT_NAME VARCHAR(100) NOT NULL,
PRICE FLOAT NOT NULL,
QUANTITY INT NOT NULL,
CREATED_AT TIMESTAMP DEFAULT NOW(),
UPDATED_AT TIMESTAMP DEFAULT NOW() ON UPDATE NOW()
);

ALTER TABLE PRODUCTS 
DROP COLUMN QUANTITY;

INSERT INTO PRODUCTS(PRODUCT_ID,PRODUCT_NAME,PRICE)
VALUES('101','JACKET','2000'),('102','PEN','1000'),('103','SHOES','2500');

CREATE TABLE CART(
CART_ID INT PRIMARY KEY NOT NULL,
USER_ID INT NOT NULL,
TOTAL_AMOUNT FLOAT NOT NULL,
CREATED_AT TIMESTAMP DEFAULT NOW(),
UPDATED_AT TIMESTAMP DEFAULT NOW() ON UPDATE NOW(),
FOREIGN KEY(USER_ID) REFERENCES USERS(ID)
);

INSERT INTO CART(CART_ID,USER_ID,TOTAL_AMOUNT)
VALUES('11','1','4000'),('12','4','6800'),('13','5','10000');

CREATE TABLE CART_ITEM(
QUANTITY INT NOT NULL,
CART_ID INT NOT NULL,
PRODUCT_ID INT NOT NULL,
PRICE FLOAT NOT NULL,
CREATED_AT TIMESTAMP DEFAULT NOW(),
UPDATED_AT TIMESTAMP DEFAULT NOW() ON UPDATE NOW(),
FOREIGN KEY(PRODUCT_ID) REFERENCES PRODUCTS(PRODUCT_ID),
FOREIGN KEY(CART_ID) REFERENCES CART(CART_ID)
);

INSERT INTO CART_ITEM(QUANTITY,CART_ID,PRODUCT_ID,PRICE)
VALUES('2','11','101','500'),('1','12','102','1000'),('2','13','103','4000'),('2','11','102','3500'),('4','12','103','5800'),('3','13','101','6000');

CREATE TABLE ADDRESSES(
	USER_ID INT NOT NULL,
    CITY VARCHAR(20) NOT NULL,
    STATE VARCHAR(20) NOT NULL,
    COUNTRY VARCHAR(20) NOT NULL,
    POSTAL_CODE VARCHAR(6) NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT NOW(),
	UPDATED_AT TIMESTAMP DEFAULT NOW() ON UPDATE NOW(),
    FOREIGN KEY(USER_ID) REFERENCES USERS(ID)
);

INSERT INTO ADDRESSES(USER_ID,CITY,STATE,COUNTRY,POSTAL_CODE)
VALUES('1','DELHI','DELHI','INDIA','100100'),('2','PUNE','MAHARASHTRA','INDIA','400082'),('3','AGRA','UTTAR PRADESH','INDIA','200100'),('4','SURAT','GUJARAT','INDIA','400100'),('5','MUMBAI','MAHARASHTRA','INDIA','400380'),('3','NOIDA','UTTAR PRADESH','INDIA','200300'),('2','INDORE','MP','INDIA','208908');


CREATE TABLE PAYMENT(
USER_ID INT NOT NULL,
PAYMENT_ID INT PRIMARY KEY NOT NULL,
PAYMENT_DATE DATE NOT NULL,
PAYMENT_TYPE VARCHAR(10) NOT NULL,
CREATED_AT TIMESTAMP DEFAULT NOW(),
UPDATED_AT TIMESTAMP DEFAULT NOW() ON UPDATE NOW(),
FOREIGN KEY(USER_ID) REFERENCES USERS(ID)
);

INSERT INTO PAYMENT(USER_ID,PAYMENT_ID,PAYMENT_DATE,PAYMENT_TYPE)
VALUES('1','99','2022-01-14','ONLINE'),('4','98','2022-01-14','CASH'),('5','97','2022-01-14','ONLINE'),('4','96','2022-01-14','CASH');


SELECT FIRST_NAME FROM USERS LEFT JOIN CART ON USERS.ID = CART.USER_ID WHERE CART_ID IS NULL;

select distinct city , count(city) from addresses group by city;

SELECT cart_id from cart  where total_amount > (select avg(total_amount) from cart);

select if(total_amount-2000 < 0, '0', total_amount-2000) as total_amount from cart;

select user_id, sum(total_amount) from cart group by user_id order by sum(total_amount) desc limit 5;

select cart_id, total_amount as orders from cart order by total_amount desc limit 5;

select product_id from cart_item group by product_id order by sum(quantity) desc limit 5;


select count(cart_id) from cart where updated_at <= '2022-01-14 15:03:38'




